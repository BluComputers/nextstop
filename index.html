<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go To Town - Driver Interface</title>
    <style>
        :root {
            --gtt-yellow: #ffd700;
            --gtt-dark: #1c1a8a;
            --gtt-dark-blue: #002d5a;
            --gtt-green: #2e7d32;
            --gtt-red: #c62828;
            --gtt-grey: #333;
            --gtt-orange: #ff9800; /* New Orange for safety buttons */
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--gtt-dark); 
            color: white; 
            margin: 0; 
            padding: 0; 
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 320px;
            background: #fff;
            color: #333;
            display: flex;
            flex-direction: column;
            border-right: 4px solid var(--gtt-yellow);
        }

        .sidebar-header {
            background: var(--gtt-dark-blue);
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        #stop-list-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .stop-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 15px;
            min-height: 60px;
        }

        .stop-item.active { background-color: #f0f4ff; }

        .stop-line-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            width: 20px;
        }

        .line-segment { width: 4px; background: var(--gtt-dark-blue); flex-grow: 1; }

        .stop-node {
            width: 14px;
            height: 14px;
            border: 3px solid var(--gtt-dark-blue);
            border-radius: 50%;
            background: white;
            z-index: 2;
        }

        .stop-item.active .stop-node { background: var(--gtt-dark-blue); }

        .stop-main-name { font-weight: bold; font-size: 1.1rem; color: #1a1a1a; }
        .stop-sub-name { font-size: 0.9rem; color: #666; }

        /* --- MAIN CONTENT --- */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: var(--gtt-dark);
            overflow-y: auto;
        }

        .header-section {
            width: 100%;
            max-width: 800px;
            margin-bottom: 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .logo-box {
            background: var(--gtt-dark-blue);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-bottom: 4px solid var(--gtt-yellow);
        }

        .logo-box img { height: 45px; margin-bottom: 10px; }

        select#route-selector {
            width: 90%;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            font-weight: bold;
        }

        .header-branding { 
            background: var(--gtt-yellow); 
            color: #000; 
            padding: 8px; 
            font-weight: 900; 
            text-transform: uppercase;
            text-align: center;
        }

        #display { 
            background: #000; 
            border: 4px solid #333; 
            padding: 40px 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            width: 95%;
            max-width: 700px;
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .label { color: var(--gtt-yellow); font-size: 1rem; text-transform: uppercase; letter-spacing: 4px; margin-bottom: 10px; }
        #stop-name { font-size: 2.5rem; font-weight: bold; color: #fff; line-height: 1.1; }

        .controls-grid {
            display: grid;
            grid-template-columns: 80px 1fr 80px; 
            gap: 15px;
            width: 95%;
            max-width: 700px;
            margin-bottom: 20px;
        }

        /* --- SAFETY BUTTONS SECTION --- */
        .safety-section {
            width: 95%;
            max-width: 700px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
        }

        button { border: none; border-radius: 12px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        button:active { transform: scale(0.95); }

        #next-btn { background: var(--gtt-green); font-size: 1.8rem; padding: 30px; box-shadow: 0 6px 0 #1b5e20; }
        .sq-btn { width: 80px; height: 80px; font-size: 0.8rem; text-transform: uppercase; }
        #skip-btn { background: var(--gtt-grey); }
        #reset-btn { background: var(--gtt-red); }
        
        .safety-btn {
            background: var(--gtt-orange);
            padding: 20px 10px;
            font-size: 1.5rem;
            box-shadow: 0 4px 0 #e68a00;
        }

        #gps-btn { background: #1565c0; width: 95%; max-width: 700px; margin-top: 15px; padding: 12px; font-size: 1rem; }
        
        .status-area { margin-top: auto; padding: 10px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; width: 100%; max-width: 700px; }
        .gps-active { color: #4caf50; font-weight: bold; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="sidebar-header" id="sidebar-route-name">Route Selector</div>
        <div id="stop-list-container"></div>
    </div>

    <div id="main-content">
        <div class="header-section">
            <div class="logo-box">
                <img src="https://www.gtt-online.co.uk/media/2193/logo.png" alt="Go To Town Logo">
                <select id="route-selector" onchange="changeRoute()">
                    <option value="service5">Service 5: Gaywood Loop</option>
                    <option value="northlynn2">North Lynn 2</option>
                    <option value="service4">Service 4: The Grange</option>
                    <option value="service3">Service 3: North & South Wootton</option>
                    <option value="service3h">Service 3H: Industrial/Retail Loop</option>
                </select>
            </div>
            <div class="header-branding" id="route-title">Service Selection</div>
        </div>

        <div id="display">
            <div class="label" id="display-label">Next Stop</div>
            <div id="stop-name">Ready To Depart</div>
        </div>

        <div class="controls-grid">
            <button id="skip-btn" class="sq-btn" onclick="skipStop()">Skip<br>Stop</button>
            <button id="next-btn" onclick="manualNext()">NEXT STOP</button>
            <button id="reset-btn" class="sq-btn" onclick="resetRoute()">Reset<br>Route</button>
        </div>

        <div class="safety-section">
            <button class="safety-btn" onclick="safetyNotice('Please remain seated')">1</button>
            <button class="safety-btn" onclick="safetyNotice('Please mind the step')">2</button>
            <button class="safety-btn" onclick="safetyNotice('Caution - Wet Floor')">3</button>
            <button class="safety-btn" onclick="clearNotice()">4</button>
        </div>

        <button id="gps-btn" onclick="toggleGPS()">ENABLE GPS TRACKING</button>

        <div class="status-area">
            <span id="counter">Stop: 0 / 0</span>
            <span id="gps-status">GPS: OFF</span>
        </div>
    </div>

    <script>
        // ROUTE DATA (As established previously)
        const routeData = {
            service5: {
                shortName: "Route 5",
                title: "Service 5 From Go To Town",
                stops: [
                    ["Bus Station Kings Lynn", "Transport Interchange", 52.7533, 0.4005],
                    ["Kettlewell Lane", "Kings Lynn (NE)", 52.7554, 0.4035],
                    ["Highgate School", "Kings Lynn (E)", 52.7562, 0.4093],
                    ["King Edward VII School", "Kings Lynn (E)", 52.7578, 0.4135],
                    ["Tesco Gaywood", "Gaywood (E)", 52.7600, 0.4225],
                    ["Railway Station", "Kings Lynn (S)", 52.7538, 0.4030],
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005]
                ]
            },
            northlynn2: {
                shortName: "Route 2",
                title: "North Lynn 2 From Go To Town",
                stops: [
                    ["Transport Interchange", "Kings Lynn (Stand C)", 52.7533, 0.4005],
                    ["Austin Fields", "Kings Lynn (NW)", 52.7575, 0.4010],
                    ["Burkitt Street", "North Lynn (E)", 52.7588, 0.3995],
                    ["Townsend Terrace", "North Lynn (E)", 52.7610, 0.3980],
                    ["Smith Avenue", "North Lynn (NW)", 52.7635, 0.3950],
                    ["Turbus Road", "North Lynn (NW)", 52.7650, 0.3930],
                    ["St Edmundsbury Road", "North Lynn (NW)", 52.7665, 0.3920],
                    ["Estuary Close", "North Lynn (NW)", 52.7680, 0.3910],
                    ["Nottingham Road", "North Lynn (E)", 52.7660, 0.3950],
                    ["Lady Jane Grey Road", "North Lynn (E)", 52.7645, 0.3980],
                    ["No.1", "North Lynn (NW)", 52.7630, 0.4000],
                    ["Reid Way", "North Lynn (NW)", 52.7620, 0.4020],
                    ["Garden Court", "North Lynn (S)", 52.7605, 0.4015],
                    ["Chadwick Square", "Kings Lynn (W)", 52.7590, 0.3985],
                    ["Railway Station", "Kings Lynn (S)", 52.7538, 0.4030],
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005]
                ]
            },
            service4: {
                shortName: "Route 4",
                title: "Service 4: The Grange From Go To Town",
                stops: [
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005],
                    ["Kettlewell Lane", "Kings Lynn (NE)", 52.7554, 0.4035],
                    ["Highgate School", "Kings Lynn (E)", 52.7562, 0.4093],
                    ["King Edward VII School", "Kings Lynn (E)", 52.7578, 0.4135],
                    ["Tesco", "Gaywood (E)", 52.7600, 0.4225],
                    ["Lavender Road", "Kings Lynn (NE)", 52.7612, 0.4210],
                    ["Railway Station", "Kings Lynn (S)", 52.7538, 0.4030],
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005]
                ]
            },
            service3: {
                shortName: "Route 3",
                title: "Service 3 From Go To Town",
                stops: [
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005],
                    ["Kettlewell Lane", "Kings Lynn (NE)", 52.7554, 0.4035],
                    ["Highgate School", "Kings Lynn (E)", 52.7562, 0.4093],
                    ["Railway Station", "Kings Lynn (S)", 52.7538, 0.4030],
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005]
                ]
            },
            service3h: {
                shortName: "Route 3H",
                title: "Service 3H From Go To Town",
                stops: [
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005],
                    ["Austin Fields", "Kings Lynn (NW)", 52.7575, 0.4010],
                    ["Retail Park", "Kings Lynn (NE)", 52.7585, 0.4080],
                    ["Bergen Way", "Kings Lynn (W)", 52.7620, 0.4120],
                    ["Railway Station", "Kings Lynn (S)", 52.7538, 0.4030],
                    ["Bus Station", "Transport Interchange", 52.7533, 0.4005]
                ]
            }
        };

        let currentRouteKey = "service5";
        let currentIndex = -1;
        let gpsActive = false;
        let watchId = null;
        let noticeActive = false;

        function renderStopList() {
            const container = document.getElementById('stop-list-container');
            const route = routeData[currentRouteKey];
            document.getElementById('sidebar-route-name').innerText = route.shortName;
            
            container.innerHTML = "";
            route.stops.forEach((stop, index) => {
                const item = document.createElement('div');
                item.className = `stop-item ${index === currentIndex ? 'active' : ''}`;
                item.id = `stop-item-${index}`;

                item.innerHTML = `
                    <div class="stop-line-box">
                        <div class="stop-node"></div>
                        ${index < route.stops.length - 1 ? '<div class="line-segment"></div>' : ''}
                    </div>
                    <div class="stop-info">
                        <div class="stop-main-name">${stop[0]}</div>
                        <div class="stop-sub-name">${stop[1]}</div>
                    </div>
                `;
                container.appendChild(item);
            });

            if (currentIndex >= 0) {
                const activeEl = document.getElementById(`stop-item-${currentIndex}`);
                if(activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function changeRoute() {
            currentRouteKey = document.getElementById('route-selector').value;
            document.getElementById('route-title').innerText = routeData[currentRouteKey].title;
            resetRoute(false);
        }

        function updateDisplay(shouldSpeak) {
            const stops = routeData[currentRouteKey].stops;
            if (currentIndex >= 0 && currentIndex < stops.length) {
                const name = stops[currentIndex][0];
                document.getElementById('display-label').innerText = "Next Stop";
                document.getElementById('stop-name').innerText = name;
                document.getElementById('counter').innerText = `Stop: ${currentIndex + 1} / ${stops.length}`;
                if (shouldSpeak) speak(`Next stop: ${name}`);
            } else if (currentIndex >= stops.length) {
                document.getElementById('stop-name').innerText = "End of Route";
            }
            renderStopList();
        }

        // SAFETY NOTICE FUNCTIONS
        function safetyNotice(msg) {
            noticeActive = true;
            document.getElementById('display-label').innerText = "Information";
            document.getElementById('stop-name').innerText = msg;
            speak(msg);
        }

        function clearNotice() {
            noticeActive = false;
            if (currentIndex === -1) {
                document.getElementById('display-label').innerText = "Next Stop";
                document.getElementById('stop-name').innerText = "Ready To Depart";
            } else {
                updateDisplay(false);
            }
        }

        function manualNext() {
            if (currentIndex < routeData[currentRouteKey].stops.length - 1) {
                currentIndex++;
                updateDisplay(true);
            }
        }

        function skipStop() {
            if (currentIndex < routeData[currentRouteKey].stops.length - 1) {
                currentIndex++;
                updateDisplay(false); 
            }
        }

        function resetRoute(ask = true) {
            if(!ask || confirm("Reset current route?")) {
                currentIndex = -1;
                document.getElementById('display-label').innerText = "Next Stop";
                document.getElementById('stop-name').innerText = "Ready To Depart";
                document.getElementById('counter').innerText = `Stop: 0 / ${routeData[currentRouteKey].stops.length}`;
                window.speechSynthesis.cancel();
                renderStopList();
            }
        }

        function toggleGPS() {
            const btn = document.getElementById('gps-btn');
            const status = document.getElementById('gps-status');
            if (!gpsActive) {
                if ("geolocation" in navigator) {
                    watchId = navigator.geolocation.watchPosition(checkLocation, null, {enableHighAccuracy: true});
                    gpsActive = true;
                    btn.innerText = "DISABLE GPS TRACKING";
                    status.innerText = "GPS: ACTIVE";
                    status.classList.add("gps-active");
                }
            } else {
                navigator.geolocation.clearWatch(watchId);
                gpsActive = false;
                btn.innerText = "ENABLE GPS TRACKING";
                status.innerText = "GPS: OFF";
                status.classList.remove("gps-active");
            }
        }

        function checkLocation(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const stops = routeData[currentRouteKey].stops;
            const nextIdx = currentIndex + 1;
            
            if (nextIdx < stops.length) {
                const targetLat = stops[nextIdx][2];
                const targetLon = stops[nextIdx][3];
                const dist = Math.sqrt(Math.pow(lat - targetLat, 2) + Math.pow(lon - targetLon, 2));
                
                if (dist < 0.0007) { 
                    currentIndex = nextIdx;
                    updateDisplay(true);
                }
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-GB';
            utterance.rate = 0.85;
            window.speechSynthesis.speak(utterance);
        }

        changeRoute();
    </script>
</body>
</html>
